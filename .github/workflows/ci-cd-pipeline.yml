name: InstaAD CI/CD Pipeline

# This section defines the "triggers" - when this workflow should run.
on:
  push:
    branches: [ "main", "master" ]      # Runs automatically when you push code to main/master.
  pull_request:
    branches: [ "main", "master" ]      # Runs when someone opens a Pull Request to main/master.

jobs:
  # ==========================================
  # JOB 1: Continuous Integration (Tests)
  # ==========================================
  build-and-test:
    runs-on: ubuntu-22.04

    # Set the default working directory for all 'run' steps in this job
    defaults:
      run:
        working-directory: ./InstaAD_generator 

    steps:
    # 1. Download the code to the GitHub server
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # 3. Install virtual display (xvfb) for PyQt5 GUI tests
    - name: Install system dependencies for PyQt5
      # Run system-level commands (apt-get) from the root directory, independent of the project folder
      working-directory: . 
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libegl1 libgl1-mesa-glx libxcb-xinerama0 libxkbcommon-x11-0 

    # Step 4: Install all the Python libraries your project needs to run.
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Ensuring testing tools are explicitly installed just in case they are missing from requirements.txt
        pip install pytest pytest-asyncio httpx

    # Step 5: Run the actual tests.
    - name: Run Pytest
      env:
        # PYTHONPATH=. tells Python to look for modules in the current root directory,
        # preventing "ModuleNotFoundError" when your tests try to import from Backend or Frontend.
        PYTHONPATH: . 
      run: |
        # xvfb-run executes pytest inside the fake virtual display we installed in Step 3.
        xvfb-run -a pytest tests/

  # ==========================================
  # JOB 2: Continuous Deployment (Docker Hub)
  # ==========================================
  build-and-push:
    # Run the job on a fresh Ubuntu virtual machine
    runs-on: ubuntu-latest 
    
    # ---> The Magic Link: Wait for the tests to pass successfully! <---
    needs: build-and-test
    
    # ---> Only run the deployment if this was a direct push (not just a pull request check) <---
    if: github.event_name == 'push'
    
    steps:
      - name: Check out code
        # Pull the repository code into the runner
        uses: actions/checkout@v3 

      - name: Log in to Docker Hub
        # Authenticate with Docker Hub using GitHub Secrets
        uses: docker/login-action@v2 
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        # Build the Dockerfile and push the final image to the registry
        uses: docker/build-push-action@v4 
        with:
          context: ./InstaAD_generator  # Path to the directory containing the Dockerfile
          push: true
          tags: danielayash30/instaad-backend:latest