name: InstaAD CI Tests

# This section defines the "triggers" - when this workflow should run.
on:
  push:
    branches: [ "main", "master" ]      # Runs automatically when you push code to main/master.
  pull_request:
    branches: [ "main", "master" ]      # Runs when someone opens a Pull Request to main/master.

jobs:
  build-and-test:
    runs-on: ubuntu-22.04 # <--- שינינו את זה מ-latest ל-22.04

    steps:
    # 1. Download the code to the GitHub server
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # 3. Install virtual display (xvfb) for PyQt5 GUI tests
    - name: Install system dependencies for PyQt5
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libegl1 libgl1-mesa-glx libxcb-xinerama0 libxkbcommon-x11-0 # <--- עדכנו את רשימת החבילות

    # Step 4: Install all the Python libraries your project needs to run.
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Ensuring testing tools are explicitly installed just in case they are missing from requirements.txt
        pip install pytest pytest-asyncio httpx

    # Step 5: Run the actual tests.
    - name: Run Pytest
      env:
        # PYTHONPATH=. tells Python to look for modules in the current root directory,
        # preventing "ModuleNotFoundError" when your tests try to import from Backend or Frontend.
        PYTHONPATH: . 
      run: |
        # xvfb-run executes pytest inside the fake virtual display we installed in Step 3.
        xvfb-run -a pytest tests/